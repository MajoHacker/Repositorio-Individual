<%- include('includes/head.ejs', {
  username: username, 
  permisos: permisos
}) %>

<br>
<div>
  <script>
  const token = '08326c86c9074fabb50cf46b25ba6434';

  async function fetchWebApi(endpoint, method, body) {
      const res = await fetch(`https://api.spotify.com/${endpoint}`, {
          headers: {
              Authorization: `Bearer ${token}`,
          },
          method,
          body: JSON.stringify(body)
      });
      return await res.json();
  }

  async function getTopTracks() {
      // Endpoint reference : https://developer.spotify.com/documentation/web-api/reference/get-users-top-artists-and-tracks
      return (await fetchWebApi(
          'v1/me/top/tracks?time_range=long_term&limit=5', 'GET'
      )).items;
  }

  async function getRecommendations() {
      const topTracks = await getTopTracks();
      const topTracksIds = topTracks.map(track => track.id);
      // Endpoint reference : https://developer.spotify.com/documentation/web-api/reference/get-recommendations
      return (await fetchWebApi(
          `v1/recommendations?limit=5&seed_tracks=${topTracksIds.join(',')}`, 'GET'
      )).tracks;
  }

  (async () => {
      const topTracks = await getTopTracks();
      console.log(
          topTracks?.map(
              ({ name, artists }) =>
                  `${name} by ${artists.map(artist => artist.name).join(', ')}`
          )
      );

      const playlistId = '0cdmMU1NIeF9qWEPdluZmJ';
      document.getElementById('spotify-embed').src = `https://open.spotify.com/embed/playlist/${playlistId}?utm_source=generator&theme=0`;
  })();
  </script>
</div>

<input type="hidden" id="_csrf" name="_csrf" value="<%= csrfToken %>" >

<br>
<input id="buscar" class="form-control" type="text" placeholder="Busca a un fan"/><br><br>

<div id="respuesta_ajax">

<div id="notificacion">
  <% if (fans.length < 1) { %>
      <div class="alert alert-info">
          <button type="button" class="close" data-dismiss="alert">&times;</button>
          No existe el fan.     
      </div>       
  <% } %>
</div>

<div class="row">


  <% let columns = 0; %>
  <% for (let fan of fans) { %>
      <% columns++ %>
      <div class="col-md-3 mb-4">
        <div class="card">
            <img src="uploads/<%= fan.nombre %>" class="card-img-top" alt="Imagen de <%= fan.nombre %>">
            <div class="card-body">
                <h5 class="card-title">@<%= fan.nombre %></h5>
            </div>
            <button class="btn btn-danger" onclick="eliminar(<%= fan.idfans %>)">Eliminar</button>
        </div>
    </div>
      
      <% if (columns % 4 == 0 && columns < fans.length) { %>
          </div>
          <div class="row">
      <% } %>
      
  <% } %>

</div>   

</div>

<% if(ultimo_fan != '') { %>
<div>El último fan fue <%- ultimo_fan %>.</div>
<% } %>

<script>

const accion_asincrona = () => {
console.log('Buscando...');
const valor_busqueda = document.getElementById('buscar').value;

//función que manda la petición asíncrona
fetch('/buscar/' + valor_busqueda, {
  method: 'GET',
  headers: {
      'Content-Type': 'application/json',
  }
}).then((result) => {
  console.log(result);
  return result.json(); //Regresa otra promesa
}).then((data) => {
  console.log(data);
  let html = '';

  html += `<div id="notificacion">`;
      if (data.fans.length < 1) { 
          html += 
              `<div class="alert alert-info">
                  <button type="button" class="close" data-dismiss="alert">&times;</button>
                  No existe el fan. 
              </div>`;           
      }
  html += `</div>`;

  html += `
  <div class="row">`;

  let columns = 0;
  for (let fan of data.fans) { 
      columns++;

      html += `
      <div class="col-md-3 mb-4">
        <div class="card">
          <img src="uploads/${fan.nombre}" class="card-img-top" alt="Imagen de ${fan.nombre}">
            <div class="card-body">
              <h5 class="card-title">@${fan.nombre}</h5>
            </div>
            <button class="btn btn-danger" onclick="eliminar(${fan.idfans})">Eliminar</button>
        </div>
    </div>
      `;

      if (columns % 4 == 0 && columns < data.fans.length) {
          html += `</div>
          <div class="row">`;
      }
  } 

  html += `</div>`;

  document.getElementById('respuesta_ajax').innerHTML = html;
}).catch(err => {
  console.log(err);
});
};

document.getElementById('buscar').onkeyup = accion_asincrona;

const eliminar = (id) => {
  console.log(id)
const csrf = document.getElementById('_csrf').value;

//función que manda la petición asíncrona
fetch('/delete', {
  method: 'POST',
  headers: {
      'Content-Type': 'application/json',
      'csrf-token': csrf
  },
  body: JSON.stringify({id: id})
}).then(result => {
  return result.json(); //Regresa otra promesa
}).then(data => {
  console.log(data);
  let html = '';
  
  html += `<div id="notificacion">`;
      if (data.fans.length < 1) { 
          html += 
              `<div class="alert alert-info">
                  <button type="button" class="close" data-dismiss="alert">&times;</button>
                  No existe el fan. 
              </div>`;           
      }
  html += `</div>`;

  html += `
  <div class="row">`;

  let columns = 0;
  for (let fan of data.fans) { 
      columns++;

      html += `
      <div class="col-md-3 mb-4">
        <div class="card">
          <img src="uploads/${fan.nombre}" class="card-img-top" alt="Imagen de ${fan.nombre}">
            <div class="card-body">
              <h5 class="card-title">@${fan.nombre}</h5>
            </div>
            <button class="btn btn-danger" onclick="eliminar(${fan.idfans})">Eliminar</button>
        </div>
    </div>`;

      if (columns % 4 == 0 && columns < data.fans.length) {
          html += `</div>
          <div class="row">`;
      }
  } 

  html += `</div>`;

  document.getElementById('respuesta_ajax').innerHTML = html;

  document.getElementById('notificacion').innerHTML = 
      `<div class="alert alert-info">
          <button type="button" class="close" data-dismiss="alert">&times;</button>
          El fan fue eliminado 
      </div>`;

}).catch(err => {
  console.log(err);
});
};

</script>

<%- include('includes/contenido.ejs') %>

<h3 class="text-center">
  Reproduce nuestra playlist:
</h3>
<div class="d-flex justify-content-center">
  <iframe id="spotify-embed" title="Spotify Embed: Recommendation Playlist" width="50%" height="360px" frameborder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy">
  </iframe>
</div>
<br>
<%- include('includes/foot.ejs') %>
